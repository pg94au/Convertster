name: Build Windows projects and create Inno Setup installer

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch: {}

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Restore NuGet packages
        run: nuget restore Convertster.sln

      - name: Build any solution (MSBuild if .sln exists)
        shell: powershell
        run: |
          $sln = Get-ChildItem -Path . -Filter *.sln -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $sln) {
            Write-Host "Found solution: $($sln.FullName). Building with MSBuild..."
            msbuild $sln.FullName /p:Configuration=Release /p:Platform=x64
          } else {
            Write-Host "No .sln found; skipping MSBuild step."
          }

      - name: Download installation prerequisites
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path Installer\Prerequisites | Out-Null
          $out = 'Installer\Prerequisites\VC_redist.x64.exe'
          Write-Host "Downloading VC++ redistributable to $out"
          Invoke-WebRequest -Uri 'https://aka.ms/vs/17/release/vc_redist.x64.exe' -OutFile $out
          if (-Not (Test-Path $out)) { Write-Error "Failed to download $out" }

      - name: Build Inno Setup installer
        shell: powershell
        run: |
          cd Installer
          & ISCC.exe -Q "Installer.iss"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: |
            Installer/Output/Convertster-1.0-Setup.exe

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            **/*.log
            **/msbuild*.log
